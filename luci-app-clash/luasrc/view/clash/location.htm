

<fieldset class="cbi-section">
	<table width="100%" cellspacing="10">
	
	    <tr><td class="align-left"><span><%:Global IP%> </span>&nbsp;:&nbsp;<span id="ip-gb"></span> <span id="ip-geo"></span></td>  <td class="align-right">  <span><%:Google%></span>&nbsp;:&nbsp;<span id="_google"><em><%:Collecting data...%></em></span></td><td class="align-right"><%:Youtube%> </span>&nbsp;:&nbsp;<span id="_youtube"><em><%:Collecting data...%></em></span></td></tr>    
		<tr><td class="align-left"><span><%:Domestic IP%> </span>&nbsp;:&nbsp;<span id="d-ip"></span></td>  <td class="align-right"> <span><%:Baidu%></span>&nbsp;:&nbsp;<span  id="_baidu"><em><%:Collecting data...%></em></span></td> <td class="align-right"><%:Taobao%> </span>&nbsp;:&nbsp;<span id="_taobao"><em><%:Collecting data...%></em></span></td></tr>

		
	</table>
</fieldset>


<script type="text/javascript"> //<![CDATA[

let random = parseInt(Math.random() * 100000000);
let IP = {
            get: (url, type) =>
                fetch(url, { method: 'GET' }).then((resp) => {
                    if (type === 'text')
                        return Promise.all([resp.ok, resp.status, resp.text(), resp.headers]);
                    else {
                        return Promise.all([resp.ok, resp.status, resp.json(), resp.headers]);
                    }
                }).then(([ok, status, data, headers]) => {
                    if (ok) {
                        let json = {
                            ok,
                            status,
                            data,
                            headers
                        }
                        return json;
                    } else {
                        throw new Error(JSON.stringify(json.error));
                    }
                }).catch(error => {
                    throw error;
                }),
          

            getIpipnetIP: () => {
                IP.get(`https://myip.ipip.net/?z=${random}`, 'text')
                    .then((resp) => {
                        let data = resp.data.replace('当前 IP：', '').split(' 来自于：');
                        document.getElementById('d-ip').innerHTML = `${data[0]} ${data[1]}`;
                    });
            },
			getIpsbIP: (data) => {
                document.getElementById('ip-gb').innerHTML = data.address;
               document.getElementById('ip-geo').innerHTML = `${data.country} ${data.province} ${data.city} ${data.isp.name}`
            },
			
           
}

IP.getIpipnetIP();
			
var HTTP = {
	checker: (domain, cbElID) => {
		let img = new Image;
		let timeout = setTimeout(() => {
			img.onerror = img.onload = null;
			img = null;
			document.getElementById(cbElID).innerHTML = '<em><b><font color=red><%:UNAVAILABLE%></font></b></em>'
		}, 1000);
		img.onerror = () => {
			clearTimeout(timeout);
			document.getElementById(cbElID).innerHTML = '<em><b><font color=red><%:TIMEOUT%></font></b></em>'
		}
		img.onload = () => {
			clearTimeout(timeout);
			document.getElementById(cbElID).innerHTML = '<em><b><font color=green><%:CONNECT OK%></font></b></em>'
		}
		img.src = `https://${domain}/favicon.ico?${+(new Date)}`
	}

}

XHR.poll(1, '<%=luci.dispatcher.build_url("admin", "services", "clash", "status")%>', null, function(x, status) {
		if ( x && x.status == 200 ) {	
			HTTP.checker('www.baidu.com', '_baidu');
			HTTP.checker('www.google.com', '_google');
			HTTP.checker('www.youtube.com', '_youtube');
			HTTP.checker('www.taobao.com', '_taobao');			
		}
});

//]]></script>
<script src="https://ipv4.ip.sb/addrinfo?callback=IP.getIpsbIP"></script>





